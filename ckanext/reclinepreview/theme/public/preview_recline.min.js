ckan.module('reclinepreview',function(jQuery,_){return{options:{i18n:{errorLoadingPreview:"Could not load preview",errorDataProxy:"DataProxy returned an error",errorDataStore:"DataStore returned an error",previewNotAvailableForDataType:"Preview not available for data type: "}},initialize:function(){this.loadPreviewDialog(preload_resource);},loadPreviewDialog:function(resourceData){var self=this;function showError(msg){msg=msg||_('error loading preview');return self.el.append('<div></div>').addClass('alert alert-error fade in').html(msg);}
resourceData.formatNormalized=this.normalizeFormat(resourceData.format);resourceData.url=this.normalizeUrl(resourceData.url);if(resourceData.formatNormalized===''){var tmp=resourceData.url.split('/');tmp=tmp[tmp.length-1];tmp=tmp.split('?');tmp=tmp[0];var ext=tmp.split('.');if(ext.length>1){resourceData.formatNormalized=ext[ext.length-1];}}
recline.Backend.Ckan.API_ENDPOINT=jQuery('body').data('site-root')+'api';if(resourceData.datastore_active){resourceData.backend='ckan';var dataset=new recline.Model.Dataset(resourceData);var errorMsg=this.options.i18n.errorLoadingPreview+': '+this.options.i18n.errorDataStore;dataset.fetch().done(function(dataset){self.initializeDataExplorer(dataset);}).fail(function(error){if(error.message)errorMsg+=' ('+error.message+')';showError(errorMsg);});}else if(resourceData.formatNormalized in{'csv':'','xls':''}){resourceData.format=resourceData.formatNormalized;resourceData.backend='dataproxy';var dataset=new recline.Model.Dataset(resourceData);var errorMsg=this.options.i18n.errorLoadingPreview+': '+this.options.i18n.errorDataProxy;dataset.fetch().done(function(dataset){dataset.bind('query:fail',function(error){jQuery('.data-view-container',self.el).hide();jQuery('.header',self.el).hide();});self.initializeDataExplorer(dataset);jQuery('.recline-query-editor .text-query').hide();}).fail(function(error){if(error.message)errorMsg+=' ('+error.message+')';showError(errorMsg);});}},initializeDataExplorer:function(dataset){var views=[{id:'grid',label:'Grid',view:new recline.View.SlickGrid({model:dataset})},{id:'graph',label:'Graph',view:new recline.View.Graph({model:dataset})},{id:'map',label:'Map',view:new recline.View.Map({model:dataset})}];var dataExplorer=new recline.View.MultiView({el:this.el,model:dataset,views:views,config:{readOnly:true}});jQuery('.menu-right a[data-action="fields"]',self.el).click();},normalizeFormat:function(format){var out=format.toLowerCase();out=out.split('/');out=out[out.length-1];return out;},normalizeUrl:function(url){if(url.indexOf('https')===0){return'http'+url.slice(5);}else{return url;}},makeEmbedLink:function(explorerState){var state=explorerState.toJSON();state.state_version=1;var queryString='?';var items=[];jQuery.each(state,function(key,value){if(typeof(value)==='object'){value=JSON.stringify(value);}
items.push(key+'='+escape(value));});queryString+=items.join('&');var iframeWidth=jQuery('.iframe-width',self.el);var iframeHeight=jQuery('.iframe-height',self.el);var width=iframeWidth.val();var height=iframeHeight.val();var link=embedPath+queryString;link+='&width='+width+'&height='+height;return link;},loadEmbeddedPreview:function(resourceData,reclineState){var self=this;var dataset=recline.Model.Dataset.restore(reclineState);var views=null;if(reclineState.currentView==='grid'){views=[{id:'grid',label:'Grid',view:new recline.View.SlickGrid({model:dataset,state:reclineState['view-grid']})}];}else if(reclineState.currentView==='graph'){views=[{id:'graph',label:'Graph',view:new recline.View.Graph({model:dataset,state:reclineState['view-graph']})}];}else if(reclineState.currentView==='map'){views=[{id:'map',label:'Map',view:new recline.View.Map({model:dataset,state:reclineState['view-map']})}];}
var dataExplorer=new recline.View.MultiView({el:self.el,model:dataset,state:reclineState,views:views});}};});