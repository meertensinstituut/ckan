{% extends "page.html" %}

{% set pkg = c.pkg_dict %}
{% set res = c.resource %}

{% block title %}{{ h.dataset_display_name(c.package) }} - {{ h.resource_display_name(res) }} - {{ super() }}{% endblock %}

{% block breadcrumb_content %}
  <li>{% link_for _('Datasets'), controller='package', action='search', highlight_actions = 'new index' %}</li>
  <li>{% link_for h.dataset_display_name(c.package)|truncate(30), controller='package', action='read', id=c.package.get('name') %}</li>
  <li class="active"><a href="">{{ h.resource_display_name(res)|truncate(30) }}</a></li>
{% endblock %}

{% block actions_content %}
  {% if res.url %}
    {% snippet 'package/snippets/back_to_package_action.html', pkg=pkg %}
    <li>
      <a class="btn resource-url-analytics resource-type-{{ res.resource_type }}" href="{{ res.url }}">
        {% if res.resource_type in ('listing', 'service') %}
          {{ _('View') }}
        {% elif  res.resource_type == 'api' %}
          {{ _('API Endpoint') }}
        {% else %}
          <i class="icon-large icon-download"></i> Download
        {%endif %}
      </a>
    </li>
  {% endif %}
  {% if config.get('ckan.datastore.enabled', false) %}
    <li>
      {% if res.webstore_url %}
        <a class="btn" data-toggle="modal" href="#modal-data-api-help"><i class="icon-large icon-beaker"></i> {{ _('Data API') }}</a>
      {% else %}
        <a class="btn disabled" rel="tooltip" title="{{ _('Data API is unavailable for this resource as DataStore is disabled') }}"><i class="icon-large icon-beaker"></i> {{ _('Data API') }}</a>
      {% endif %}
    </li>
  {% endif %}
{% endblock %}

{% block primary_content %}
  <section class="module">
    <div class="module-content prose">
      <h1>{{ h.resource_display_name(res) }}</h1>

      <div class="notes" property="rdfs:label">
        {{ res.description or _('(No description)') }}
        {% if not res.description and c.package.notes %}
          <div>{{ h.markdown_extract(c.package.get('notes')) }}</div>
          <small>From the <a href="{{ h.url_for(controller='package', action='read', id=c.package['name']) }}">Dataset</a></small>
        {% endif %}
      </div>
    </div>
    <div class="resource-preview module-content">
      {# TODO: Hiding data preview until we have javascript in place #}
      <div class="preview-header" style="display: none;">
        <h3>Preview</h3>
        {% if c.pkg.is_private %}
          <span title="Cannot embed as resource is private." class="btn disabled">Embed</span>
        {% else %}
          <a class="btn btn-primary" data-toggle="modal" href=".modal-data-viewer-embed-dialog">Embed</a>
        {% endif %}
      </div>
      <div id="ckanext-datapreview module-content"></div>
    </div>
  </section>

  {% if res %}
    <section class="module">
      <div class="module-content">
        <h2>Additional Information</h2>
        <table class="table table-striped table-bordered table-condensed">
          <thead>
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            {% with blacklist = ["name", "description", "url"] %}
              {% for key,value in res.items()|sort if key not in blacklist %}
                <tr><th>{{ key }}</th><td>{{ value }}</td></tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}

  {% if config.get('ckan.datastore.enabled', false) %}
    <section class="module">
      {{ data_api_help(c.datastore_api) }}
    </section>
  {% endif %}
{% endblock %}

{% block secondary_module %}
  <section class="module module-narrow">
    <h2 class="heading"><i class="icon-large icon-info-sign"></i> Resource Information</h2>
    <ul class="simple-list">
      <li><i class="ckan-icon ckan-icon-calendar"></i> Last Updated: {{ h.render_datetime(res.last_modified) or _("unknown") }}</li>
      <li><i class="ckan-icon ckan-icon-file"></i> Format: {{ res.mimetype_inner or res.mimetype or _("unknown") }}</li>
      <li><i class="ckan-icon ckan-icon-lock"></i> {% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</li>
    </ul>
  </section>

  {% snippet "package/snippets/resources.html", resources=pkg.resources, pkg=pkg, active=res.id %}

  {% snippet "snippets/social.html" %}
{% endblock %}
