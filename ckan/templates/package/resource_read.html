{% extends "page.html" %}

{% set pkg = c.pkg_dict %}
{% set res = c.resource %}

{% block title %}{{ h.dataset_display_name(c.package) }} - {{ h.resource_display_name(res) }} - {{ super() }}{% endblock %}

{% block breadcrumb_content %}
  <li>{% link_for _('Datasets'), controller='package', action='search', highlight_actions = 'new index' %}</li>
  <li>{% link_for h.dataset_display_name(c.package)|truncate(20), controller='package', action='read', id=c.package.get('name') %}</li>
  <li class="active"><a href="">{{ h.resource_display_name(res)|truncate(30) }}</a></li>
{% endblock %}

{% block actions_content %}
  {% if res.url %}
    {% snippet 'package/snippets/back_to_package_action.html', pkg=pkg %}
    <li>
      <a class="btn resource-url-analytics resource-type-{{ res.resource_type }}" href="{{ res.url }}">
        {% if res.resource_type in ('listing', 'service') %}
          {{ _('View') }}
        {% elif  res.resource_type == 'api' %}
          {{ _('API Endpoint') }}
        {% else %}
          <i class="icon-large icon-download"></i> Download
        {%endif %}
      </a>
    </li>
  {% endif %}
  {% if config.get('ckan.datastore.enabled', false) %}
    <li>
      {% if res.webstore_url %}
        <a class="btn" data-toggle="modal" href="#modal-data-api-help"><i class="icon-large icon-beaker"></i> {{ _('Data API') }}</a>
      {% else %}
        <a class="btn disabled" rel="tooltip" title="{{ _('Data API is unavailable for this resource as DataStore is disabled') }}"><i class="icon-large icon-beaker"></i> {{ _('Data API') }}</a>
      {% endif %}
    </li>
  {% endif %}
{% endblock %}

{% block main_content %}
  {{ self.flash() }}
  {{ self.toolbar() }}

  <section class="module">
    <div class="module-content">
      <h1 class="page-heading">{{ h.resource_display_name(res) }}</h1>
      <div class="prose notes" property="rdfs:label">
        {{ res.description or _('(No description)') }}
        {% if not res.description and c.package.notes %}
          <div>{{ h.markdown_extract(c.package.get('notes')) }}</div>
          <small>From the <a href="{{ h.url_for(controller='package', action='read', id=c.package['name']) }}">Dataset</a></small>
        {% endif %}
      </div>
    </div>
    <div id="ckanext-datapreview" class="module-content"></div>
  </section>

  {{ self.primary() }}
  {{ self.secondary() }}
{% endblock %}

{% block primary_content %}
  {% if res %}
    <section class="module">
      <div class="module-content">
        <h2>Additional Information</h2>
        <table class="table table-striped table-bordered table-condensed">
          <thead>
            <tr>
              <th>Field</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            {% with blacklist = ["name", "description", "url"] %}
              {% for key,value in res.items()|sort if value and key not in blacklist %}
                <tr><th>{{ key }}</th><td>{{ value }}</td></tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}

  {% if config.get('ckan.datastore.enabled', false) %}
    <section class="module">
      {{ data_api_help(c.datastore_api) }}
    </section>
  {% endif %}
{% endblock %}

{% block secondary_content %}
  <section class="module module-narrow">
    <h2 class="module-heading"><i class="icon-medium icon-info-sign"></i> Resource Information</h2>
    <ul class="simple-list">
      <li><i class="ckan-icon ckan-icon-calendar"></i> Last Updated: {{ h.render_datetime(res.last_modified) or _("unknown") }}</li>
      <li><i class="ckan-icon ckan-icon-file"></i> Format: {{ res.mimetype_inner or res.mimetype or _("unknown") }}</li>
      <li><i class="ckan-icon ckan-icon-lock"></i> {% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</li>
    </ul>
  </section>

  {% snippet "package/snippets/resources.html", pkg=pkg, active=res.id %}

  {% snippet "snippets/social.html" %}

  {# TODO: Embed this with javascript
  <section class="module">
    <div class="resource-preview module-content">
      <div class="preview-header" style="display: none;">
        <h3>Preview</h3>
        {% if c.pkg.is_private %}
          <span title="Cannot embed as resource is private." class="btn disabled">Embed</span>
        {% else %}
          <a class="btn btn-primary" data-toggle="modal" href=".modal-data-viewer-embed-dialog">Embed</a>
        {% endif %}
      </div>
      <div id="ckanext-datapreview module-content">
        {# {% snippet 'snippets/datapreview_embed_dialog.html' %} #}
      </div>
    </div>
  </section>
  #}
{% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/leaflet.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/leaflet.ie.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/slick.grid.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/slick.columnpicker.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/recline.grid.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/recline.map.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/recline.graph.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/datapreview.css' %}" />
  <link rel="stylesheet" href="{% url_for_static '/base/datapreview/css/datapreview.table-view.css' %}" />
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{% url_for_static '/base/javascript/vendor/jquery.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/jquery.flot.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/jquery.mustache.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/jquery.event.drag.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/underscore.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/backbone.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/leaflet.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/slick.grid.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/slick.columnpicker.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/vendor/recline.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/datapreview.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/table-view.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/table-view.ui.js' %}"></script>
  <script src="{% url_for_static '/base/datapreview/javascript/table-view-template.js' %}"></script>
  <script>
    var preload_resource = {{ h.literal(c.resource_json) }};
    var embedPath = "{{ h.url_for(controller='package', action='resource_embedded_dataviewer', id=c.package.id, resource_id=c.resource.id, qualified=True) }}";
  </script>
{% endblock %}
